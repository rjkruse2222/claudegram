# CodeRabbit configuration for Claudegram
# See: https://docs.coderabbit.ai/reference/configuration
#
# Workflow:
#   1. Code & commit on a branch
#   2. Run `/coderabbit:review` locally (CLI) for quick iteration
#   3. Create PR — auto-review fires ONCE on PR creation (GitHub bot)
#   4. Fix findings, push — NO auto-review on subsequent pushes
#   5. Manually trigger `@coderabbitai review` on PR if you want another pass

language: "en-US"
tone_instructions: "Be direct and technical. Focus on security, correctness, and real bugs over style nitpicks. Skip praise — just flag issues."

reviews:
  profile: "assertive"
  request_changes_workflow: false
  high_level_summary: true
  high_level_summary_in_walkthrough: true
  collapse_walkthrough: false
  sequence_diagrams: true
  poem: false
  in_progress_fortune: false
  review_details: true
  enable_prompt_for_ai_agents: true

  auto_review:
    enabled: true                    # Auto-review on PR creation
    auto_incremental_review: false   # Do NOT re-review on every push
    drafts: false                    # Skip draft PRs
    ignore_title_keywords:
      - "WIP"
      - "DO NOT REVIEW"

  # Exclude local-only files and generated output from review
  path_filters:
    - "!CLAUDE.md"
    - "!AGENTS.md"
    - "!CLAUDE_AGENT_SDK_MIGRATION_MASTER_PLAN.md"
    - "!MEDIUM_*.md"
    - "!scripts/medium_*.py"
    - "!dist/**"
    - "!node_modules/**"
    - "!package-lock.json"

  # Path-specific review instructions
  path_instructions:
    - path: "src/bot/handlers/**"
      instructions: |
        Focus on: error sanitization (use sanitizeError() for user-facing messages),
        proper cleanup of temp files on all error paths, and race condition prevention
        (pending results keyed by messageId, not chatId).
    - path: "src/utils/**"
      instructions: |
        These are security-critical utilities. Check for: SSRF protection in URL handling,
        path traversal prevention, proper file descriptor cleanup, and no token/secret leakage.
    - path: "src/media/**"
      instructions: |
        Check for: SSRF protection on user-provided URLs, proper error sanitization,
        and safe handling of external tool invocations (yt-dlp). No tokens in CLI args.
    - path: "src/telegram/**"
      instructions: |
        Focus on: Telegram API limits (4096 char messages, rate limiting on edits),
        proper MarkdownV2 escaping, and .unref() on any intervals/timers.
    - path: "src/claude/**"
      instructions: |
        Agent SDK integration. Check for: proper session lifecycle management,
        streaming error handling, abort controller usage, and settingSources config.
    - path: "docs/**"
      instructions: |
        Check for: accessibility (ARIA attributes), security (rel="noopener noreferrer"
        on external links), and no hardcoded personal paths or credentials.
    - path: "scripts/**"
      instructions: |
        Operational scripts. Check for: proper error handling, NVM path resolution,
        and no hardcoded credentials or absolute paths.

  # Disable tools we don't need (not a Python/Go/Ruby/PHP project)
  tools:
    ruff:
      enabled: false
    phpstan:
      enabled: false
    phpmd:
      enabled: false
    phpcs:
      enabled: false
    golangci-lint:
      enabled: false
    rubocop:
      enabled: false
    swiftlint:
      enabled: false
    detekt:
      enabled: false
    flake8:
      enabled: false
    pylint:
      enabled: false
    clippy:
      enabled: false
    sqlfluff:
      enabled: false
    fortitudeLint:
      enabled: false
    checkov:
      enabled: false
    pmd:
      enabled: false
    clang:
      enabled: false
    cppcheck:
      enabled: false
    buf:
      enabled: false
    regal:
      enabled: false
    brakeman:
      enabled: false
    luacheck:
      enabled: false
    shopifyThemeCheck:
      enabled: false
    prismaLint:
      enabled: false
    circleci:
      enabled: false
    # Keep enabled: biome, eslint, oxc (JS/TS), shellcheck, markdownlint,
    # gitleaks, htmlhint, yamllint, hadolint, semgrep, actionlint

chat:
  auto_reply: true

knowledge_base:
  code_guidelines:
    enabled: true
    # CLAUDE.md and AGENTS.md are gitignored (local-only), so key guidance
    # is embedded in path_instructions above instead.
  learnings:
    scope: "local"
  web_search:
    enabled: true
